// Generated by CoffeeScript 1.3.1
(function() {
  'use strict';

  var MAIN_FRAME_SELECTOR, PAYMENT_FIELD_REGEX, inbox, linkCSS, payment,
    _this = this;

  console.log('Value for Gmail extension script loaded');

  window.addEventListener('hashchange', function() {
    if (window.location.hash.match(/compose/)) {
      return payment.renderButton();
    }
  });

  MAIN_FRAME_SELECTOR = '#canvas_frame';

  PAYMENT_FIELD_REGEX = /^\$[+-]?[0-9]{1,3}(?:,?[0-9]{3})*(?:\.[0-9]{2})?\$/;

  linkCSS = function($frame) {
    return $frame.contents().find('head').append($('<link/>', {
      rel: 'stylesheet',
      type: 'text/css',
      href: chrome.extension.getURL('gmail_canvas.css')
    }));
  };

  payment = {
    renderButton: function() {
      var $actions, $frame;
      $frame = $(MAIN_FRAME_SELECTOR);
      linkCSS($frame);
      $actions = $frame.contents().find('div[role=navigation]').last().children().first();
      $actions.children('span').remove();
      $actions.children().last().before('<div id="payment-button">$<input type="text" name="pay_amount" /></div>');
      return $actions.find('#payment-button').on('blur', _this.paymentFieldHandler);
    },
    hasCreatedPayment: false,
    paymentFieldHandler: function(e) {
      var $subject, amount, hasCreatedPayment;
      amount = $(e.currentTarget).val();
      console.log(amount);
      $subject = $(MAIN_FRAME_SELECTOR).contents().find('input[name=subject]');
      if (hasCreatedPayment) {
        return $subject.val($subject.val().replace(PAYMENT_FIELD_REGEX, "$" + amount + "$"));
      } else {
        hasCreatedPayment = true;
        return $subject.val("$" + amount + "$ " + ($subject.val()));
      }
    }
  };

  inbox = {
    sort: function() {
      var $emails, emails;
      $emails = $(MAIN_FRAME_SELECTOR).contents().find('table > colgroup').eq(1).parent().find('tr');
      emails = _(emails).map(function(email, i) {
        var subject, value;
        subject = email.find('td[role=link] div > span:first-child').text();
        value = subject.match(PAYMENT_FIELD_REGEX);
        if (value != null) {
          value = parseFloat(value[0][{
            1: -2
          }]);
        } else {
          value = 0;
        }
        return {
          subject: subject,
          value: value,
          index: i
        };
      });
      return console.log(emails);
    }
  };

  $(MAIN_FRAME_SELECTOR).load(function() {
    console.log('main frame loaded');
    if (window.location.hash.match(/inbox/)) {
      return inbox.sort();
    } else if (window.location.hash.match(/compose/)) {
      return payment.renderButton();
    }
  });

  $(function() {});

}).call(this);
